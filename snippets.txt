## Process Image Function
def process_profile_image(content: bytes) -> str:
    with Image.open(BytesIO(content)) as original:
        img = ImageOps.exif_transpose(original)

        img = ImageOps.fit(img, (300, 300), method=Image.Resampling.LANCZOS)

        if img.mode in ("RGBA", "LA", "P"):
            img = img.convert("RGB")

        filename = f"{uuid.uuid4().hex}.jpg"
        filepath = PROFILE_PICS_DIR / filename

        PROFILE_PICS_DIR.mkdir(parents=True, exist_ok=True)

        img.save(filepath, "JPEG", quality=85, optimize=True)

    return filename



## Delete Profile Image Function
def delete_profile_image(filename: str | None) -> None:
    if filename is None:
        return

    filepath = PROFILE_PICS_DIR / filename
    if filepath.exists():
        filepath.unlink()



## Upload Profile Picture Endpoint
@router.patch("/{user_id}/picture", response_model=UserPrivate)
async def upload_profile_picture(
    user_id: int,
    file: UploadFile,
    current_user: CurrentUser,
    db: Annotated[AsyncSession, Depends(get_db)],
):
    if current_user.id != user_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Not authorized to update this user's picture",
        )

    content = await file.read()

    if len(content) > settings.max_upload_size_bytes:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"File too large. Maximum size is {settings.max_upload_size_bytes // (1024 * 1024)}MB",
        )

    try:
        new_filename = await run_in_threadpool(process_profile_image, content)
    except UnidentifiedImageError as err:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Invalid image file. Please upload a valid image (JPEG, PNG, GIF, WebP).",
        ) from err

    old_filename = current_user.image_file

    current_user.image_file = new_filename
    await db.commit()
    await db.refresh(current_user)

    if old_filename:
        delete_profile_image(old_filename)

    return current_user



## Delete Profile Picture Endpoint
@router.delete("/{user_id}/picture", response_model=UserPrivate)
async def delete_user_picture(
    user_id: int,
    current_user: CurrentUser,
    db: Annotated[AsyncSession, Depends(get_db)],
):
    if current_user.id != user_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Not authorized to delete this user's picture",
        )

    old_filename = current_user.image_file

    if old_filename is None:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="No profile picture to delete",
        )

    current_user.image_file = None
    await db.commit()
    await db.refresh(current_user)

    delete_profile_image(old_filename)

    return current_user



## Profile Picture HTML
    <!-- Profile Picture Section -->
    <div class="mb-4">
      <h5>Profile Picture</h5>
      <!-- Preview container -->
      <div class="mb-3">
        <img id="imagePreview"
             class="rounded-circle d-none object-fit-cover"
             alt="Image preview"
             width="150"
             height="150">
      </div>
      <!-- File input and upload button -->
      <div class="d-flex gap-2 align-items-start">
        <input type="file"
               class="form-control file-input-sm"
               id="pictureInput"
               accept="image/*">
        <button type="button" class="btn btn-primary" id="uploadPictureBtn" disabled>Upload</button>
      </div>
      <small class="text-body-secondary">Maximum file size: 5MB. Supported formats: JPEG, PNG, GIF, WebP.</small>
    </div>



## Image Preview Handler
  // Image Preview Handler
  const pictureInput = document.getElementById('pictureInput');
  const imagePreview = document.getElementById('imagePreview');
  const uploadBtn = document.getElementById('uploadPictureBtn');

  pictureInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.src = e.target.result;
        imagePreview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);

      uploadBtn.disabled = false;
    } else {
      imagePreview.classList.add('d-none');
      uploadBtn.disabled = true;
    }
  });



## Upload Profile Picture Handler
  // Upload Profile Picture Handler
  uploadBtn.addEventListener('click', async () => {
    const token = getToken();
    if (!token) {
      window.location.href = '/login';
      return;
    }

    const file = pictureInput.files[0];
    if (!file) {
      return;
    }

    // Use FormData for file uploads (not JSON)
    const formData = new FormData();
    formData.append('file', file);

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';

    try {
      const response = await fetch(`/api/users/${currentUserId}/picture`, {
        method: 'PATCH',
        headers: {
          // Don't set Content-Type â€” browser sets multipart boundary automatically
          'Authorization': `Bearer ${token}`,
        },
        body: formData,
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      if (response.status === 403) {
        document.getElementById('errorMessage').textContent =
          'You are not authorized to update this profile picture.';
        showModal('errorModal');
        return;
      }

      if (response.ok) {
        const data = await response.json();

        clearUserCache();

        document.getElementById('profileImage').src = data.image_path;

        pictureInput.value = '';
        imagePreview.classList.add('d-none');

        document.getElementById('successMessage').textContent =
          'Profile picture updated successfully!';
        showModal('successModal');
      } else {
        const error = await response.json();
        document.getElementById('errorMessage').textContent = getErrorMessage(error);
        showModal('errorModal');
      }
    } catch (error) {
      document.getElementById('errorMessage').textContent =
        'Network error. Please check your connection and try again.';
      showModal('errorModal');
    } finally {
      uploadBtn.disabled = pictureInput.files.length === 0;
      uploadBtn.textContent = 'Upload';
    }
  });